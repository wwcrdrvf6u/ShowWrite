<Window x:Class="ShowWrite.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
        Title="ShowWrite视频展台" WindowState="Maximized" Background="#2B2B2B" WindowStyle="None"
        MouseWheel="Window_MouseWheel">
    <Window.Resources>
        <!-- 按钮基础样式 -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="#2C3E50"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Width" Value="64"/>
            <Setter Property="Height" Value="64"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                BorderBrush="#34495E" BorderThickness="1" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#34495E"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#2980B9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ToggleButton基础样式 -->
        <Style TargetType="ToggleButton">
            <Setter Property="Background" Value="#2C3E50"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Width" Value="64"/>
            <Setter Property="Height" Value="64"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                BorderBrush="#34495E" BorderThickness="1" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#34495E"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#2980B9"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#2980B9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 照片按钮特殊样式 -->
        <Style TargetType="Button" x:Key="PhotoButtonStyle">
            <Setter Property="Width" Value="64"/>
            <Setter Property="Height" Value="64"/>
        </Style>

        <!-- 画笔设置按钮样式 -->
        <Style TargetType="Button" x:Key="PenSettingsButtonStyle">
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#555"/>
        </Style>

        <!-- 更多按钮样式 -->
        <Style x:Key="MoreButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Black"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Width" Value="64"/>
            <Setter Property="Height" Value="64"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                BorderBrush="#34495E" BorderThickness="1" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#333333"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#555555"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 视频区域 - 完全移除 RenderTransform 定义，由代码控制 -->
        <Grid x:Name="VideoArea" Grid.Row="0"
              ClipToBounds="True"
              IsManipulationEnabled="True"
              ManipulationStarting="VideoArea_ManipulationStarting"
              ManipulationDelta="VideoArea_ManipulationDelta"
              MouseDown="VideoArea_MouseDown"
              MouseMove="VideoArea_MouseMove"
              MouseUp="VideoArea_MouseUp"
              MouseLeftButtonDown="VideoArea_MouseLeftButtonDown">
            <!-- RenderTransform 已在代码中初始化，此处不再重复定义 -->
            <Image x:Name="VideoImage" Stretch="Uniform" />
            <InkCanvas x:Name="Ink" Background="Transparent" />
        </Grid>

        <!-- 优化后的底部工具栏 -->
        <DockPanel Grid.Row="1" Background="#2C3E50" Height="70" LastChildFill="False">
            <!-- 左侧功能区（更多/最小化/扫一扫） -->
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" Margin="10,0">
                <Button x:Name="MoreButton" Style="{StaticResource MoreButtonStyle}" Content="更多" Margin="5,0"
                        Click="MoreButton_Click"/>
                <Button Click="Minimize_Click" Margin="5,0" Content="最小化"/>
                <Button Click="ScanQRCode_Click" Margin="5,0" Content="扫一扫"/>
            </StackPanel>

            <!-- 中间主菜单 - 居中显示 -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                <!-- 移动 / 画笔 / 橡皮擦 -->
                <ToggleButton x:Name="MoveBtn" Click="MoveBtn_Click" Content="移动" IsChecked="True" Margin="5,0"/>
                <ToggleButton x:Name="PenBtn" Click="PenBtn_Click" Content="画笔" Margin="5,0"/>
                <ToggleButton x:Name="EraserBtn" Click="EraserBtn_Click" Content="橡皮" Margin="5,0"/>

                <!-- 撤回 / 清屏 -->
                <Button Click="UndoInk_Click" Margin="20,0,5,0" Content="撤销"/>
                <Button Click="RedoInk_Click" Margin="5,0" Content="重做"/>
                <Button Click="ClearInk_Click" Margin="5,0" Content="清屏"/>

                <!-- 拍照 / 扫描 -->
                <Button Click="Capture_Click" Margin="5,0" Content="拍照"/>
                <Button Click="ScanDocument_Click" Margin="5,0" Content="扫描"/>
            </StackPanel>

            <!-- 右侧照片功能 -->
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" Margin="0,0,10,0">
                <Button x:Name="PhotoBtn" Click="TogglePhotoPanel_Click" Style="{StaticResource PhotoButtonStyle}" Content="照片"/>
                <Popup x:Name="PhotoTipPopup" PlacementTarget="{Binding ElementName=PhotoBtn}" Placement="Top" AllowsTransparency="True" StaysOpen="False">
                    <Border Background="#333" CornerRadius="4" Padding="5">
                        <TextBlock Text="已拍摄" Foreground="White" FontSize="14"/>
                    </Border>
                </Popup>
            </StackPanel>
        </DockPanel>

        <!-- 照片悬浮窗 - 增加高度 -->
        <Popup x:Name="PhotoPopup" PlacementTarget="{Binding ElementName=PhotoBtn}" Placement="Left" StaysOpen="False">
            <Border Width="400" Height="600" Background="#2C3E50" CornerRadius="6" BorderBrush="White" BorderThickness="1">
                <DockPanel>
                    <TextBlock Text="拍摄记录" Foreground="White" FontSize="16" FontWeight="Bold" Margin="10" DockPanel.Dock="Top"/>
                    <ListBox x:Name="PhotoList" SelectionChanged="PhotoList_SelectionChanged">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="6">
                                    <Image Width="70" Height="52" Source="{Binding Thumbnail}" Stretch="UniformToFill" />
                                    <StackPanel Margin="10,0,0,0">
                                        <TextBlock Foreground="White" FontWeight="Bold" Text="{Binding Timestamp}" />
                                        <TextBlock Foreground="#DDDDDD" FontSize="12" Text="{Binding Strokes.Count, StringFormat='笔迹数: {0}'}" />
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Vertical" HorizontalAlignment="Center" Margin="10">
                        <Button Click="BackToLive_Click" Width="100" Height="40" Content="返回实时"/>
                        <Button Click="SaveImage_Click" Width="100" Height="40" Content="保存图片"/>
                    </StackPanel>
                </DockPanel>
            </Border>
        </Popup>

        <!-- 画笔设置悬浮窗 -->
        <Popup x:Name="PenSettingsPopup" PlacementTarget="{Binding ElementName=PenBtn}" Placement="Top" StaysOpen="False"
               AllowsTransparency="True" PopupAnimation="Fade">
            <Border Width="240" Background="#2C3E50" CornerRadius="6" BorderBrush="White" BorderThickness="1"
                    Padding="10">
                <StackPanel>
                    <!-- 标题 -->
                    <TextBlock Text="画笔设置" Foreground="White" FontSize="14" FontWeight="Bold" 
                               Margin="0,0,0,10" HorizontalAlignment="Center"/>

                    <!-- 笔宽设置 -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <TextBlock Text="笔宽:" Foreground="White" VerticalAlignment="Center" Width="40"/>
                        <Slider x:Name="PenWidthSlider" Minimum="1" Maximum="20" Value="2" Width="120"
                                ValueChanged="PenWidthSlider_ValueChanged"/>
                        <TextBlock x:Name="PenWidthValue" Text="2" Foreground="White" VerticalAlignment="Center" 
                                   Margin="10,0,0,0" Width="20"/>
                    </StackPanel>

                    <!-- 颜色选择 -->
                    <TextBlock Text="颜色:" Foreground="White" Margin="0,0,0,5"/>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- 第一行颜色 -->
                        <Button Grid.Row="0" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Black" Click="ColorButton_Click" Tag="Black"/>
                        <Button Grid.Row="0" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Red" Click="ColorButton_Click" Tag="Red"/>
                        <Button Grid.Row="0" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Green" Click="ColorButton_Click" Tag="Green"/>
                        <Button Grid.Row="0" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Blue" Click="ColorButton_Click" Tag="Blue"/>
                        <Button Grid.Row="0" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Yellow" Click="ColorButton_Click" Tag="Yellow"/>

                        <!-- 第二行颜色 -->
                        <Button Grid.Row="1" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="White" Click="ColorButton_Click" Tag="White"/>
                        <Button Grid.Row="1" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Orange" Click="ColorButton_Click" Tag="Orange"/>
                        <Button Grid.Row="1" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Purple" Click="ColorButton_Click" Tag="Purple"/>
                        <Button Grid.Row="1" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Cyan" Click="ColorButton_Click" Tag="Cyan"/>
                        <Button Grid.Row="1" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Magenta" Click="ColorButton_Click" Tag="Magenta"/>

                        <!-- 第三行颜色 -->
                        <Button Grid.Row="2" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Brown" Click="ColorButton_Click" Tag="Brown"/>
                        <Button Grid.Row="2" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Pink" Click="ColorButton_Click" Tag="Pink"/>
                        <Button Grid.Row="2" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Gray" Click="ColorButton_Click" Tag="Gray"/>
                        <Button Grid.Row="2" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="DarkRed" Click="ColorButton_Click" Tag="DarkRed"/>
                        <Button Grid.Row="2" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="DarkGreen" Click="ColorButton_Click" Tag="DarkGreen"/>

                        <!-- 第四行颜色 -->
                        <Button Grid.Row="3" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="DarkBlue" Click="ColorButton_Click" Tag="DarkBlue"/>
                        <Button Grid.Row="3" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Gold" Click="ColorButton_Click" Tag="Gold"/>
                        <Button Grid.Row="3" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Silver" Click="ColorButton_Click" Tag="Silver"/>
                        <Button Grid.Row="3" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Lime" Click="ColorButton_Click" Tag="Lime"/>
                        <Button Grid.Row="3" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Background="Teal" Click="ColorButton_Click" Tag="Teal"/>
                    </Grid>

                    <!-- 关闭按钮 -->
                    <Button Content="关闭" Click="ClosePenSettings_Click" Margin="0,10,0,0" 
                            Background="#34495E" Foreground="White" Height="30"/>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 触控信息悬浮窗 -->
        <Popup x:Name="TouchInfoPopup" 
               Placement="Absolute" 
               AllowsTransparency="True" 
               StaysOpen="True"
               IsOpen="True"
               PopupAnimation="Fade">
            <Border Background="#CC2C3E50" 
                    CornerRadius="8" 
                    Padding="15,10"
                    BorderBrush="#34495E"
                    BorderThickness="2"
                    MinWidth="250">
                <StackPanel>
                    <TextBlock Text="触控信息" 
                               Foreground="White" 
                               FontSize="16" 
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,5"/>
                    <TextBlock x:Name="TouchCountText" 
                               Foreground="White" 
                               FontSize="14" 
                               Text="触控点数: 0"/>
                    <TextBlock x:Name="TouchAreaText" 
                               Foreground="#DDDDDD" 
                               FontSize="12"
                               Text="面积: 0 像素²"
                               Margin="0,2,0,0"/>
                    <TextBlock x:Name="SDKTouchAreaText" 
                       Foreground="#DDDDDD" 
                       FontSize="12"
                       Text="SDK识别面积: 0 像素²"
                       Margin="0,2,0,0"/>
                    <TextBlock x:Name="TouchCenterText" 
                               Foreground="#DDDDDD" 
                               FontSize="12"
                               Text="中心: (0, 0)"
                               Margin="0,2,0,0"/>
                    <Button Content="关闭" 
                            Click="CloseTouchInfo_Click" 
                            Margin="0,10,0,0" 
                            Background="#34495E" 
                            Foreground="White" 
                            Height="25"
                            FontSize="12"/>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 更多菜单弹出窗口 -->
        <Popup x:Name="MoreMenuPopup" PlacementTarget="{Binding ElementName=MoreButton}" Placement="Top" StaysOpen="False"
               AllowsTransparency="True" PopupAnimation="Fade" Closed="MoreMenuPopup_Closed">
            <Border Width="150" Background="#2C3E50" CornerRadius="6" BorderBrush="White" BorderThickness="1">
                <StackPanel>
                    <Button Content="切换摄像头" Click="SwitchCamera_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="White" Height="40"/>
                    <Button Content="画面调节" Click="OpenAdjustVideo_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="White" Height="40"/>
                    <Button Content="梯形校正" Click="OpenPerspectiveCorrection_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="White" Height="40"/>
                    <Button Content="清除校正" Click="ClearCorrection_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="White" Height="40"/>
                    <Button Content="设置" Click="OpenSettings_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="White" Height="40"/>
                    <Button Content="退出" Click="Exit_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="White" Height="40"/>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</Window>