<Window x:Class="ShowWrite.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
        Title="ShowWrite视频展台" WindowState="Maximized" Background="{DynamicResource WindowBackgroundBrush}" WindowStyle="None"
        xmlns:local="clr-namespace:ShowWrite"
        MouseWheel="Window_MouseWheel" Width="1558">

    <Window.Resources>
        <!-- 使用一个 ResourceDictionary 包装所有资源 -->
        <ResourceDictionary>
            <!-- 导入深色主题资源字典（默认） -->
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="themes/DarkTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- 画笔设置按钮样式 -->
            <Style TargetType="Button" x:Key="PenSettingsButtonStyle">
                <Setter Property="Width" Value="32"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="Margin" Value="2"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="BorderBrush" Value="#555"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="2">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- 对钩图标几何数据 -->
            <Geometry x:Key="CheckIconGeometry">M46 14L25 35.6l-7-7.2l-7 7.2L25 50l28-28.8z</Geometry>

            <!-- 对钩图标样式 -->
            <Style x:Key="CheckIconStyle" TargetType="Path">
                <Setter Property="Data" Value="{StaticResource CheckIconGeometry}"/>
                <Setter Property="Stretch" Value="Uniform"/>
                <Setter Property="Width" Value="20"/>
                <Setter Property="Height" Value="20"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="Fill" Value="#FFFFFF"/>
                <Setter Property="Visibility" Value="Collapsed"/>
            </Style>

            <!-- 颜色按钮容器样式 -->
            <Style x:Key="ColorButtonContainerStyle" TargetType="Grid">
                <Setter Property="Width" Value="24"/>
                <Setter Property="Height" Value="24"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>

            <!-- 颜色方块样式 -->
            <Style x:Key="ColorRectangleStyle" TargetType="Rectangle">
                <Setter Property="Width" Value="24"/>
                <Setter Property="Height" Value="24"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="RadiusX" Value="2"/>
                <Setter Property="RadiusY" Value="2"/>
                <Setter Property="Stroke" Value="#666"/>
                <Setter Property="StrokeThickness" Value="1"/>
            </Style>

            <!-- 照片选择状态提示转换器 -->
            <local:PhotoSelectedTipConverter x:Key="PhotoSelectedTipConverter"/>
        </ResourceDictionary>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 视频区域 - 使用正确的变换定义 -->
        <Grid x:Name="VideoArea" Grid.Row="0"
              ClipToBounds="True"
              IsManipulationEnabled="True"
              ManipulationStarting="VideoArea_ManipulationStarting"
              ManipulationDelta="VideoArea_ManipulationDelta"
              MouseDown="VideoArea_MouseDown"
              MouseMove="VideoArea_MouseMove"
              MouseUp="VideoArea_MouseUp"
              MouseLeftButtonDown="VideoArea_MouseLeftButtonDown">
            <!-- 添加 RenderTransform 定义 -->
            <Grid.RenderTransform>
                <TransformGroup>
                    <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1" />
                    <TranslateTransform x:Name="PanTransform" X="0" Y="0" />
                </TransformGroup>
            </Grid.RenderTransform>
            <Image x:Name="VideoImage" Stretch="Uniform" />
            <InkCanvas x:Name="Ink" Background="Transparent" />
        </Grid>

        <!-- 优化后的底部工具栏 -->
        <Grid x:Name="BottomToolbar" Grid.Row="1" Background="{DynamicResource ToolbarBackgroundBrush}" Height="70">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧功能区（更多/最小化/扫一扫） -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="10,0" VerticalAlignment="Center">
                <Button x:Name="MoreButton" Style="{DynamicResource MoreButtonStyle}" Margin="5,0,5,0"
                        Click="MoreButton_Click">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M4 6a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H5a1 1 0 0 1-1-1m0 12a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H5a1 1 0 0 1-1-1m1-7a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2z"/>
                        </Viewbox>
                        <TextBlock Text="更多" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
                <Button Style="{DynamicResource ButtonStyle}" Click="Minimize_Click" Margin="5,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="29" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M18 3.25H6A2.75 2.75 0 0 0 3.25 6v6a.75.75 0 0 0 1.5 0V6A1.25 1.25 0 0 1 6 4.75h12A1.25 1.25 0 0 1 19.25 6v12A1.25 1.25 0 0 1 18 19.25h-6a.75.75 0 0 0 0 1.5h6A2.75 2.75 0 0 0 20.75 18V6A2.75 2.75 0 0 0 18 3.25 M11.21 13.19a.8.8 0 0 0 .29.06h4a.75.75 0 0 0 0-1.5h-2.19l3.22-3.22a.75.75 0 0 0-1.06-1.06l-3.22 3.22V8.5a.75.75 0 0 0-1.5 0v4a.8.8 0 0 0 .06.29a.7.7 0 0 0 .4.4 M8 14.25H5A1.76 1.76 0 0 0 3.25 16v3A1.76 1.76 0 0 0 5 20.75h3A1.76 1.76 0 0 0 9.75 19v-3A1.76 1.76 0 0 0 8 14.25 M8.25 19a.25.25 0 0 1-.25.25H5a.25.25 0 0 1-.25-.25v-3a.25.25 0 0 1 .25-.25h3a.25.25 0 0 1 .25.25Z"/>
                        </Viewbox>
                        <TextBlock Text="最小化" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
                <Button Style="{DynamicResource ButtonStyle}" Click="ScanQRCode_Click" Margin="5,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M9 3H3v6h2V5h4zM3 21v-6h2v4h4v2zM15 3v2h4v4h2V3zm4 12h2v6h-6v-2h4zM7 7h4v4H7zm0 6h4v4H7zm10-6h-4v4h4zm-4 6h4v4h-4z"/>
                        </Viewbox>
                        <TextBlock Text="扫一扫" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
            </StackPanel>

            <!-- 中间主菜单 - 居中显示 -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                <!-- 移动 / 画笔 / 橡皮擦 -->
                <ToggleButton x:Name="MoveBtn" Click="MoveBtn_Click" IsChecked="True" Margin="5,0,-3,0" Style="{DynamicResource ToolToggleButtonStyle}">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path x:Name="MoveIcon">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Fill" Value="{DynamicResource IconBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                                                <Setter Property="Fill" Value="White"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Data>M302.189 329.126H196.105l55.831 135.993c3.889 9.428-.555 19.999-9.444 23.999l-49.165 21.427c-9.165 4-19.443-.571-23.332-9.714l-53.053-129.136l-86.664 89.138C18.729 472.71 0 463.554 0 447.977V18.299C0 1.899 19.921-6.096 30.277 5.443l284.412 292.542c11.472 11.179 3.007 31.141-12.5 31.141</Path.Data>
                            </Path>
                        </Viewbox>
                        <TextBlock Text="移动" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </ToggleButton>
                <ToggleButton x:Name="PenBtn" Click="PenBtn_Click" Margin="5,0,-3,0" Style="{DynamicResource ToolToggleButtonStyle}">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path x:Name="PenIcon">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Fill" Value="{DynamicResource IconBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                                                <Setter Property="Fill" Value="White"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Data>M4.2 20.975q-.525.125-.913-.262t-.262-.913l.875-4.25l4.55 4.55zm5.875-2.1l-4.95-4.95L15.45 3.6q.575-.575 1.425-.575T18.3 3.6l2.1 2.1q.575.575.575 1.425T20.4 8.55z</Path.Data>
                            </Path>
                        </Viewbox>
                        <TextBlock Text="画笔" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </ToggleButton>
                <ToggleButton x:Name="EraserBtn" Click="EraserBtn_Click" Margin="5,0" Style="{DynamicResource ToolToggleButtonStyle}">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path x:Name="EraserIcon">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Fill" Value="{DynamicResource IconBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                                                <Setter Property="Fill" Value="White"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Data>M3.121 17.85a3 3 0 0 1 0-4.243l7.071-7.072l8.486 8.486l-3.243 3.242H20a1 1 0 1 1 0 2H6.778a3 3 0 0 1-2.121-.878L3.12 17.849zm16.97-4.243l1.415-1.415a3 3 0 0 0 0-4.242l-4.243-4.243a3 3 0 0 0-4.242 0l-1.414 1.414z</Path.Data>
                            </Path>
                        </Viewbox>
                        <TextBlock Text="橡皮" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </ToggleButton>

                <!-- 撤回 / 清屏 -->
                <Button Style="{DynamicResource ButtonStyle}" Click="UndoInk_Click" Margin="20,0,-3,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M16 3C12 3 8.4 4.8 6 7.7V4H4v8h8v-2H6.8c2-3 5.3-5 9.2-5c6.1 0 11 4.9 11 11s-4.9 11-11 11S5 22.1 5 16H3c0 7.2 5.8 13 13 13s13-5.8 13-13S23.2 3 16 3"/>
                        </Viewbox>
                        <TextBlock Text="撤销" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
                <Button Style="{DynamicResource ButtonStyle}" Click="RedoInk_Click" Margin="5,0,-3,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M16 3C8.832 3 3 8.832 3 16s5.832 13 13 13s13-5.832 13-13h-2c0 6.086-4.914 11-11 11S5 22.086 5 16S9.914 5 16 5c3.875 0 7.262 1.984 9.219 5H20v2h8V4h-2v3.719C23.617 4.844 20.02 3 16 3"/>
                        </Viewbox>
                        <TextBlock Text="重做" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
                <Button Style="{DynamicResource ButtonStyle}" Click="ClearInk_Click" Margin="5,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M16.5 4.478v.227a49 49 0 0 1 3.878.512a.75.75 0 1 1-.256 1.478l-.209-.035l-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A49 49 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a53 53 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951m-6.136-1.452a51 51 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a50 50 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452m-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058z"/>
                        </Viewbox>
                        <TextBlock Text="清屏" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>

                <!-- 拍照 / 扫描 -->
                <Button Style="{DynamicResource ButtonStyle}" Click="Capture_Click" Margin="5,0,-3,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M19 6.5h-1.28l-.32-1a3 3 0 0 0-2.84-2H9.44A3 3 0 0 0 6.6 5.55l-.32 1H5a3 3 0 0 0-3 3v8a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-8a3 3 0 0 0-3-3.05m1 11a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h2a1 1 0 0 0 1-.68l.54-1.64a1 1 0 0 1 .95-.68h5.12a1 1 0 0 1 .95.68l.54 1.64a1 1 0 0 0 .9.68h2a1 1 0 0 1 1 1Zm-8-9a4 4 0 1 0 4 4a4 4 0 0 0-4-4m0 6a2 2 0 1 1 2-2a2 2 0 0 1-2 2"/>
                        </Viewbox>
                        <TextBlock Text="拍照" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
                <Button Style="{DynamicResource ButtonStyle}" Click="ScanDocument_Click" Margin="5,0">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M13 9h5l-5-5zM4 22v-5h16v5zm-3-7v-2h22v2zm3-4V2h10l6 6v3z"/>
                        </Viewbox>
                        <TextBlock Text="扫描" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
            </StackPanel>

            <!-- 右侧照片功能 - 修改：靠右对齐，紧贴右侧 -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,5,0" VerticalAlignment="Center">
                <Button x:Name="PhotoBtn" Style="{DynamicResource PhotoButtonStyle}" Width="214" Click="TogglePhotoPanel_Click">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Viewbox Width="30" Height="30">
                            <Path Fill="{DynamicResource IconBrush}" Data="M19 4H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3M5 18a1 1 0 0 1-1-1v-2.42l3.3-3.29a1 1 0 0 1 1.4 0L15.41 18Zm15-1a1 1 0 0 1-1 1h-.77l-3.81-3.83l.88-.88a1 1 0 0 1 1.4 0l3.3 3.29Zm0-3.24l-1.88-1.87a3.06 3.06 0 0 0-4.24 0l-.88.88l-2.88-2.88a3.06 3.06 0 0 0-4.24 0L4 11.76V7a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1Z"/>
                        </Viewbox>
                        <TextBlock Text="照片" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                </Button>
                <Popup x:Name="PhotoTipPopup" PlacementTarget="{Binding ElementName=PhotoBtn}" Placement="Top" AllowsTransparency="True" StaysOpen="False">
                    <Border Background="#333" CornerRadius="4" Padding="5">
                        <TextBlock Text="已拍摄" Foreground="White" FontSize="14"/>
                    </Border>
                </Popup>
            </StackPanel>
        </Grid>


        <!-- 照片悬浮窗 - 显示在右下角 -->
        <Popup x:Name="PhotoPopup" 
       Placement="Absolute" 
       StaysOpen="False"
       AllowsTransparency="True">
            <Border Width="400" Height="500" Background="#2C3E50" CornerRadius="6" BorderBrush="White" BorderThickness="1">
                <DockPanel>
                    <TextBlock Text="拍摄记录" Foreground="White" FontSize="16" FontWeight="Bold" Margin="10" DockPanel.Dock="Top"/>

                    <!-- 照片列表 -->
                    <ListBox x:Name="PhotoList">
                        <!-- 数据模板将由 PhotoPopupManager 动态创建 -->
                    </ListBox>

                    <StackPanel DockPanel.Dock="Bottom" Orientation="Vertical" HorizontalAlignment="Center" Margin="10">
                        <Button Style="{DynamicResource ButtonStyle}" Click="BackToLive_Click" Width="100" Height="40">
                            <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock Text="返回实时" FontSize="10" HorizontalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                            </StackPanel>
                        </Button>
                        <Button Style="{DynamicResource ButtonStyle}" Click="SaveImage_Click" Width="100" Height="40">
                            <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock Text="保存图片" FontSize="10" HorizontalAlignment="Center" Margin="0,2,0,0" Foreground="{DynamicResource TextBrush}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </DockPanel>
            </Border>
        </Popup>

        <!-- 画笔设置悬浮窗 -->
        <Popup x:Name="PenSettingsPopup" PlacementTarget="{Binding ElementName=PenBtn}" Placement="Top" StaysOpen="False"
               AllowsTransparency="True" PopupAnimation="Fade" Opened="PenSettingsPopup_Opened">
            <Border Width="240" Background="{DynamicResource PopupBackground}" CornerRadius="6" BorderBrush="{DynamicResource PopupBorder}" BorderThickness="1"
                    Padding="10">
                <StackPanel>
                    <!-- 标题 -->
                    <TextBlock Text="画笔设置" Foreground="{DynamicResource TextBrush}" FontSize="14" FontWeight="Bold" 
                               Margin="0,0,0,10" HorizontalAlignment="Center"/>

                    <!-- 笔宽设置 -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <TextBlock Text="笔宽:" Foreground="{DynamicResource TextBrush}" VerticalAlignment="Center" Width="40"/>
                        <Slider x:Name="PenWidthSlider" Minimum="1" Maximum="20" Value="2" Width="120"
                                ValueChanged="PenWidthSlider_ValueChanged"/>
                        <TextBlock x:Name="PenWidthValue" Text="2" Foreground="{DynamicResource TextBrush}" VerticalAlignment="Center" 
                                   Margin="10,0,0,0" Width="20"/>
                    </StackPanel>

                    <!-- 颜色选择 -->
                    <TextBlock Text="颜色:" Foreground="{DynamicResource TextBrush}" Margin="0,0,0,5"/>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- 第一行颜色 -->
                        <Button Grid.Row="0" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Black" ToolTip="黑色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Black"/>
                                <Path x:Name="CheckIcon_Black" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="0" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Red" ToolTip="红色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Red"/>
                                <Path x:Name="CheckIcon_Red" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="0" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Green" ToolTip="绿色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Green"/>
                                <Path x:Name="CheckIcon_Green" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="0" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Blue" ToolTip="蓝色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Blue"/>
                                <Path x:Name="CheckIcon_Blue" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="0" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Yellow" ToolTip="黄色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Yellow"/>
                                <Path x:Name="CheckIcon_Yellow" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>

                        <!-- 第二行颜色 -->
                        <Button Grid.Row="1" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="White" ToolTip="白色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="White"/>
                                <Path x:Name="CheckIcon_White" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="1" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Orange" ToolTip="橙色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Orange"/>
                                <Path x:Name="CheckIcon_Orange" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="1" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Purple" ToolTip="紫色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Purple"/>
                                <Path x:Name="CheckIcon_Purple" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="1" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Cyan" ToolTip="青色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Cyan"/>
                                <Path x:Name="CheckIcon_Cyan" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="1" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Magenta" ToolTip="洋红色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Magenta"/>
                                <Path x:Name="CheckIcon_Magenta" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>

                        <!-- 第三行颜色 -->
                        <Button Grid.Row="2" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Brown" ToolTip="棕色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Brown"/>
                                <Path x:Name="CheckIcon_Brown" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="2" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Pink" ToolTip="粉色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Pink"/>
                                <Path x:Name="CheckIcon_Pink" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="2" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Gray" ToolTip="灰色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Gray"/>
                                <Path x:Name="CheckIcon_Gray" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="2" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="DarkRed" ToolTip="深红色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="DarkRed"/>
                                <Path x:Name="CheckIcon_DarkRed" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="2" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="DarkGreen" ToolTip="深绿色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="DarkGreen"/>
                                <Path x:Name="CheckIcon_DarkGreen" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>

                        <!-- 第四行颜色 -->
                        <Button Grid.Row="3" Grid.Column="0" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="DarkBlue" ToolTip="深蓝色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="DarkBlue"/>
                                <Path x:Name="CheckIcon_DarkBlue" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="3" Grid.Column="1" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Gold" ToolTip="金色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Gold"/>
                                <Path x:Name="CheckIcon_Gold" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="3" Grid.Column="2" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Silver" ToolTip="银色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Silver"/>
                                <Path x:Name="CheckIcon_Silver" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="3" Grid.Column="3" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Lime" ToolTip="柠檬色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Lime"/>
                                <Path x:Name="CheckIcon_Lime" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                        <Button Grid.Row="3" Grid.Column="4" Style="{StaticResource PenSettingsButtonStyle}" 
                                Click="ColorButton_Click" Tag="Teal" ToolTip="蓝绿色">
                            <Grid Style="{StaticResource ColorButtonContainerStyle}">
                                <Rectangle Style="{StaticResource ColorRectangleStyle}" Fill="Teal"/>
                                <Path x:Name="CheckIcon_Teal" Style="{StaticResource CheckIconStyle}"/>
                            </Grid>
                        </Button>
                    </Grid>

                    <!-- 关闭按钮 -->
                    <Button Click="ClosePenSettings_Click" Margin="0,10,0,0" 
                            Background="{DynamicResource ButtonBackground}" Foreground="{DynamicResource TextBrush}" Height="30">
                        <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="关闭" FontSize="10" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 触控信息悬浮窗 -->
        <Popup x:Name="TouchInfoPopup" 
               Placement="Absolute" 
               AllowsTransparency="True" 
               StaysOpen="True"
               IsOpen="True"
               PopupAnimation="Fade">
            <Border Background="#CC2C3E50" 
                    CornerRadius="8" 
                    Padding="15,10"
                    BorderBrush="#34495E"
                    BorderThickness="2"
                    MinWidth="250">
                <StackPanel>
                    <TextBlock Text="触控信息" 
                               Foreground="White" 
                               FontSize="16" 
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,5"/>
                    <TextBlock x:Name="TouchCountText" 
                               Foreground="White" 
                               FontSize="14" 
                               Text="触控点数: 0"/>
                    <TextBlock x:Name="TouchAreaText" 
                               Foreground="#DDDDDD" 
                               FontSize="12"
                               Text="面积: 0 像素²"
                               Margin="0,2,0,0"/>
                    <TextBlock x:Name="SDKTouchAreaText" 
                       Foreground="#DDDDDD" 
                       FontSize="12"
                       Text="SDK识别面积: 0 像素²"
                       Margin="0,2,0,0"/>
                    <TextBlock x:Name="TouchCenterText" 
                               Foreground="#DDDDDD" 
                               FontSize="12"
                               Text="中心: (0, 0)"
                               Margin="0,2,0,0"/>
                    <Button Click="CloseTouchInfo_Click" 
                            Margin="0,10,0,0" 
                            Background="#34495E" 
                            Foreground="White" 
                            Height="25"
                            FontSize="12">
                        <StackPanel Orientation="Vertical" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="关闭" FontSize="10" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 更多菜单弹出窗口 - 修改：按钮内容居中 -->
        <Popup x:Name="MoreMenuPopup" PlacementTarget="{Binding ElementName=MoreButton}" Placement="Top" StaysOpen="False"
               AllowsTransparency="True" PopupAnimation="Fade" Closed="MoreMenuPopup_Closed">
            <Border Width="150" Background="{DynamicResource PopupBackground}" CornerRadius="6" BorderBrush="{DynamicResource PopupBorder}" BorderThickness="1">
                <StackPanel HorizontalAlignment="Stretch">
                    <Button Click="SwitchCamera_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextBrush}" Height="40"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">
                        <TextBlock Text="切换摄像头" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="OpenAdjustVideo_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextBrush}" Height="40"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">
                        <TextBlock Text="画面调节" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="OpenPerspectiveCorrection_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextBrush}" Height="40"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">
                        <TextBlock Text="梯形校正" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="ClearCorrection_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextBrush}" Height="40"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">
                        <TextBlock Text="清除校正" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="OpenSettings_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextBrush}" Height="40"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">
                        <TextBlock Text="设置" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="Exit_Click" 
                            Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextBrush}" Height="40"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">
                        <TextBlock Text="退出" VerticalAlignment="Center"/>
                    </Button>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 梯形校正模式界面 - 移到最顶层 -->
        <Grid x:Name="PerspectiveCorrectionGrid" 
              Grid.Row="0" 
              Grid.RowSpan="2"
              Panel.ZIndex="1000"
              Background="#CC2B2B2B"
              Visibility="Collapsed">
            <!-- 添加一个背景层来确保视频内容可见 -->
            <Grid Background="#33000000">
                <!-- 校正点容器 -->
                <Canvas x:Name="CorrectionCanvas" 
                        Background="Transparent"
                        MouseLeftButtonDown="CorrectionCanvas_MouseDown"
                        MouseMove="CorrectionCanvas_MouseMove"
                        MouseLeftButtonUp="CorrectionCanvas_MouseUp">
                    <!-- 校正四边形 -->
                    <Polygon x:Name="CorrectionPolygon" 
                             Stroke="White" 
                             StrokeThickness="2" 
                             StrokeDashArray="5,5"
                             Fill="#40FFFFFF"
                             Points="100,100 500,100 500,300 100,300"/>

                    <!-- 四个校正点 -->
                    <Ellipse x:Name="CorrectionPoint0" 
                             Canvas.Left="100" Canvas.Top="100"
                             Width="20" Height="20" 
                             Fill="Red" Cursor="Hand"/>
                    <Ellipse x:Name="CorrectionPoint1" 
                             Canvas.Left="500" Canvas.Top="100"
                             Width="20" Height="20" 
                             Fill="Red" Cursor="Hand"/>
                    <Ellipse x:Name="CorrectionPoint2" 
                             Canvas.Left="500" Canvas.Top="300"
                             Width="20" Height="20" 
                             Fill="Red" Cursor="Hand"/>
                    <Ellipse x:Name="CorrectionPoint3" 
                             Canvas.Left="100" Canvas.Top="300"
                             Width="20" Height="20" 
                             Fill="Red" Cursor="Hand"/>

                    <!-- 点标签 -->
                    <TextBlock x:Name="CorrectionLabel0" 
                               Canvas.Left="110" Canvas.Top="125"
                               Text="点1" Foreground="White" FontSize="12"/>
                    <TextBlock x:Name="CorrectionLabel1" 
                               Canvas.Left="510" Canvas.Top="125"
                               Text="点2" Foreground="White" FontSize="12"/>
                    <TextBlock x:Name="CorrectionLabel2" 
                               Canvas.Left="510" Canvas.Top="325"
                               Text="点3" Foreground="White" FontSize="12"/>
                    <TextBlock x:Name="CorrectionLabel3" 
                               Canvas.Left="110" Canvas.Top="325"
                               Text="点4" Foreground="White" FontSize="12"/>
                </Canvas>

                <!-- 校正控制按钮 -->
                <StackPanel Orientation="Horizontal" 
                            HorizontalAlignment="Center" 
                            VerticalAlignment="Bottom"
                            Margin="0,0,0,20">
                    <Button Style="{DynamicResource ButtonStyle}" x:Name="ApplyCorrectionButton" 
                            Content="完成" 
                            Click="ApplyCorrectionButton_Click"
                            Margin="5" Width="80" Height="40"/>
                    <Button Style="{DynamicResource ButtonStyle}" x:Name="ResetCorrectionButton" 
                            Content="重置" 
                            Click="ResetCorrectionButton_Click"
                            Margin="5" Width="80" Height="40"/>
                    <Button Style="{DynamicResource ButtonStyle}" x:Name="CancelCorrectionButton" 
                            Content="取消" 
                            Click="CancelCorrectionButton_Click"
                            Margin="5" Width="80" Height="40"/>
                </StackPanel>

                <!-- 提示文本 -->
                <TextBlock Text="拖动红点调整校正区域，完成后点击'完成'按钮" 
                           Foreground="White" FontSize="14"
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Top"
                           Margin="0,20,0,0"/>
            </Grid>
        </Grid>
    </Grid>
</Window>